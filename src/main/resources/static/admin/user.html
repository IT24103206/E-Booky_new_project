<script src="adminCheck.js"></script>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ebooky3 - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/user.css">
</head>
<body>
<!-- Navigation Bar -->
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#"><i class="bi bi-book"></i> <span>E-booky</span></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link active" href="index.html"><i class="bi bi-house-door"></i> Home</a></li>
                <li class="nav-item"><a class="nav-link" href="book.html"><i class="bi bi-book"></i> Books</a></li>
                <li class="nav-item"><a class="nav-link" href="user.html"><i class="bi bi-people"></i> Users</a></li>
                <li class="nav-item"><a class="nav-link" href="payments.html"><i class="bi bi-people"></i> Payments</a></li>
                <li class="nav-item"><a class="nav-link" href="reservation.html"><i class="bi bi-people"></i> Reservation</a></li>
            </ul>
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-bell"></i></a></li>
                <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-gear"></i></a></li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle"></i> Admin
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#"><i class="bi bi-person"></i> Profile</a></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
    <header class="my-4 text-center">


    </header>

    <div class="row">
        <div class="container mt-4">
            <div class="tab-content">
                <!-- Users Tab -->
                <div class="tab-pane fade show active" id="usersTab">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h3>User Management</h3>
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                Add New User
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Type</th>
                                        <th>Actions</th>
                                    </tr>
                                    </thead>
                                    <tbody id="userTableBody1">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Add User Modal -->
                <div class="modal fade" id="addUserModal" tabindex="-1" >
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add New User</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="addUserForm">
                                    <div class="mb-3">
                                        <label for="addFirstName" class="form-label">First Name</label>
                                        <input type="text" class="form-control" id="addFirstName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="addLastName" class="form-label">Last Name</label>
                                        <input type="text" class="form-control" id="addLastName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="addEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="addEmail" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="addPassword" class="form-label">Password</label>
                                        <input type="password" class="form-control" id="addPassword" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="addUserType" class="form-label">User Type</label>
                                        <select class="form-select" id="addUserType" required>
                                            <option value="RegularUser">Regular User</option>
                                            <option value="AdminUser">Admin User</option>
                                        </select>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" id="saveAddUser">Save User</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit User Modal -->
                <div class="modal fade" id="editUserModal" tabindex="-1" >
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Edit User</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editUserForm">
                                    <input type="hidden" id="editUserId">
                                    <div class="mb-3">
                                        <label for="editFirstName" class="form-label">First Name</label>
                                        <input type="text" class="form-control" id="editFirstName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="editLastName" class="form-label">Last Name</label>
                                        <input type="text" class="form-control" id="editLastName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="editEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="editEmail" required>
                                    </div>
                                    <input type="hidden" id="editUserType">
                                    <input type="hidden" id="hidden-password">
                                    <!--                            <div class="mb-3">-->
                                    <!--                                <label for="editUserType" class="form-label">User Type</label>-->
                                    <!--                                <select class="form-select" id="editUserType" required>-->
                                    <!--                                    <option value="RegularUser">Regular User</option>-->
                                    <!--                                    <option value="AdminUser">Admin User</option>-->
                                    <!--                                </select>-->
                                    <!--                            </div>-->
                                    <div class="mb-3">
                                        <label for="editPassword" class="form-label">New Password (leave blank to keep current)</label>
                                        <input type="password" class="form-control" id="editPassword">
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" id="saveEditUser">Save changes</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete User Confirmation Modal -->
                <div class="modal fade" id="deleteUserModal" tabindex="-1" >
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Confirm User Deletion</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>Are you sure you want to delete this user? This action cannot be undone.</p>
                                <input type="hidden" id="deleteUserId">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteUser">Delete User</button>
                            </div>
                        </div>
                    </div>
                </div>


                <div id="toastContainer" class="toast-container"></div>

                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
                <script>
                    const userTable = document.getElementById("userTableBody1");
                    let users = [];

                    // Sample JavaScript for demonstration
                    document.addEventListener('DOMContentLoaded', async function() {

                        async function  loadUsers() {
                            const response = await fetch("/users");
                            if(!response.ok) throw new Error('Failed to fetch books');

                            users = await response.json();
                            displayUsers();
                        }

                        await loadUsers();

                        document.querySelectorAll('.edit-user').forEach(button => {
                            button.addEventListener('click', function() {
                                const userId = this.getAttribute('data-id');
                                // In a real app, you would fetch user details from an API
                                const user = users.find(u => u.userId == userId);
                                if (!user) {
                                    console.error("User not found!");
                                    return;
                                }
                                const modalEl = document.getElementById('editUserModal');
                                const modal = new bootstrap.Modal(modalEl);

                                // Show the modal first
                                modal.show();

                                // Wait for the modal to be fully visible before injecting values
                                modalEl.addEventListener('shown.bs.modal', function onShown() {
                                    // Remove event listener after it's triggered once
                                    modalEl.removeEventListener('shown.bs.modal', onShown);

                                    // Now it's safe to interact with modal DOM
                                    document.getElementById('editUserId').value = user.userId;
                                    document.getElementById('editFirstName').value = user.firstName;
                                    document.getElementById('editLastName').value = user.lastName;
                                    document.getElementById('editEmail').value = user.email;
                                    document.getElementById('hidden-password').value = user["password"];
                                    document.getElementById('editUserType').value = user["@type"];
                                });
                            });
                        });
                        //
                        // Delete user buttons
                        document.querySelectorAll('.delete-user').forEach(button => {
                            button.addEventListener('click', function() {
                                const userId = this.getAttribute('data-id');
                                document.getElementById('deleteUserId').value = userId;

                                const modal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
                                modal.show();
                            });
                        });
                        //
                        // Confirm delete user
                        document.getElementById('confirmDeleteUser').addEventListener('click',async function() {
                            const userId = document.getElementById('deleteUserId').value;

                            try{
                                const response = await fetch(`/user/${userId}`,{
                                    method:"delete",
                                    credentials:"include"
                                });
                                if (response.ok){
                                    await closeAllModalsAndReload();
                                }
                            }catch (ex){
                                console.error(ex);
                            }

                            showToast('User deleted successfully', 'success');

                            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteUserModal'));
                            modal.hide();
                        });
                        //
                        // Save new user
                        document.getElementById('saveAddUser').addEventListener('click',async function() {

                            const firstName = document.getElementById("addFirstName").value;
                            const lastName = document.getElementById("addLastName").value;
                            const email = document.getElementById("addEmail").value;
                            const password = document.getElementById("addPassword").value;
                            const type = document.getElementById("addUserType").value;

                            try{
                                const response = await fetch("/users/register",{
                                    method:"post",
                                    credentials: 'include',
                                    headers: {
                                        'Content-Type': 'application/json' // Tell server you're sending JSON
                                    },
                                    body:JSON.stringify({
                                        "@type": type,
                                        "userId": 1,
                                        "firstName": firstName,
                                        "lastName": lastName,
                                        "email": email,
                                        "password": password,
                                        "adminRole":"Super",
                                    })
                                });

                                if(response.ok){
                                    await closeAllModalsAndReload();
                                }

                            }catch (ex){
                                console.error(ex);
                            }

                            showToast('User added successfully', 'success');

                            const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
                            modal.hide();
                        });

                        function closeAllModalsAndReload() {
                            // Close all visible modals
                            document.querySelectorAll('.modal.show').forEach(modalEl => {
                                const modalInstance = bootstrap.Modal.getInstance(modalEl);
                                if (modalInstance) {
                                    // Move focus away to avoid accessibility warnings
                                    document.activeElement.blur();
                                    modalInstance.hide();
                                }
                            });

                            // Reload users
                            loadUsers();
                        }

                        // Save edited user
                        document.getElementById('saveEditUser').addEventListener('click',async function() {

                            const firstName = document.getElementById("editFirstName").value;
                            const lastName = document.getElementById("editLastName").value;
                            const email = document.getElementById("editEmail").value;
                            const password = document.getElementById("editPassword").value  || document.getElementById("hidden-password").value;
                            const userId = document.getElementById("editUserId").value;
                            const type = document.getElementById("editUserType").value;

                            try{
                                const response = await fetch(`/users/${userId}`,{
                                    method:"PUT",
                                    credentials: 'include',
                                    headers: {
                                        'Content-Type': 'application/json' // Tell server you're sending JSON
                                    },
                                    body:JSON.stringify({
                                        "@type": type,
                                        "userId": userId,
                                        "firstName": firstName,
                                        "lastName": lastName,
                                        "email": email,
                                        "password":password,
                                    })
                                });

                                if(response.ok){
                                    await closeAllModalsAndReload();
                                    showToast('User updated successfully', 'success');
                                }

                            }catch (ex){
                                console.error(ex);
                                showToast('User updated unsuccessful', 'error');
                            }

                            document.activeElement.blur();

                            const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                            modal.hide();
                        });
                        // Helper function to show toast messages
                        function showToast(message, type = 'info') {
                            const toastContainer = document.getElementById('toastContainer');
                            const toastEl = document.createElement('div');
                            toastEl.className = `toast show align-items-center text-white bg-${type} border-0`;
                            toastEl.setAttribute('role', 'alert');
                            toastEl.setAttribute('aria-live', 'assertive');
                            toastEl.setAttribute('aria-atomic', 'true');

                            toastEl.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                `;

                            toastContainer.appendChild(toastEl);

                            setTimeout(() => {
                                toastEl.classList.remove('show');
                                setTimeout(() => toastEl.remove(), 300);
                            }, 3000);
                        }
                    });

                    function displayUsers() {
                        userTable.innerText = "";
                        users.forEach(user=>{
                            const userType = user["@type"];
                            const userTypeName = userType==="AdminUser"?"Admin":"user";
                            const element = `<tr>
                                        <td>${user.userId}</td>
                                        <td>${user.firstName} ${user.lastName}</td>
                                        <td>${user.email}</td>
                                        <td><span class="badge ${userType==="AdminUser"?"badge-admin":"badge-user"} ">${userTypeName}</span></td>
                                        <td class="action-buttons">
                                            <button class="btn btn-info btn-sm btn-action edit-user" data-id="${user.userId}">Edit</button>
                                            <button class="btn btn-danger btn-sm btn-action delete-user" data-id="${user.userId}">Delete</button>
                                        </td>`;
                            userTable.innerHTML += element;
                        })
                    }
                </script>
</body>
</html>